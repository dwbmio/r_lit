# 最终配置：混合构建成本分析

## 支持的平台（7 个）

### Linux（musl，静态链接）
1. **x86_64-unknown-linux-musl** - 64位 Intel/AMD
2. **i686-unknown-linux-musl** - 32位 Intel/AMD
3. **aarch64-unknown-linux-musl** - 64位 ARM（树莓派、服务器）

### macOS
4. **x86_64-apple-darwin** - Intel Mac
5. **aarch64-apple-darwin** - Apple Silicon (M1/M2/M3)

### Windows
6. **x86_64-pc-windows-gnu** - 64位 Windows
7. **i686-pc-windows-gnu** - 32位 Windows

## 构建策略

### Job 1: Linux musl（Ubuntu runner）
- 并行构建 3 个 musl 目标
- 使用原生 cargo + musl-tools
- 完全静态链接

### Job 2: macOS（macOS runner）
- 并行构建 2 个 macOS 目标
- 使用原生 cargo

### Job 3: Windows（Ubuntu runner + cross）
- 并行构建 2 个 Windows 目标
- 使用 cross 交叉编译

### Job 4: Release（Ubuntu runner）
- 收集所有二进制
- 创建 GitHub Release
- 生成校验和

## 预估构建时间

### Linux musl job
- x86_64: ~5 分钟
- i686: ~5 分钟
- aarch64: ~6 分钟
- **最长：6 分钟**（并行执行）

### macOS job
- x86_64: ~6 分钟
- aarch64: ~6 分钟
- **最长：6 分钟**（并行执行）

### Windows job
- x86_64: ~7 分钟
- i686: ~7 分钟
- **最长：7 分钟**（并行执行）

### Release job
- 打包和发布：~2 分钟

**总时间：** ~21 分钟（jobs 并行执行，取最长）

## 成本计算

### Runner 定价（2026）

| Runner | 倍率 | 基础价格 | 平台费用 | 总价/分钟 |
|--------|------|---------|---------|----------|
| Linux | 1x | $0.008 | $0.002 | $0.010 |
| macOS | 10x | $0.080 | $0.002 | $0.082 |

### 单次发版成本

**Linux musl job:**
- 时间：6 分钟
- 成本：6 × $0.010 = **$0.06**

**macOS job:**
- 时间：6 分钟
- 成本：6 × $0.082 = **$0.492**

**Windows job:**
- 时间：7 分钟
- 成本：7 × $0.010 = **$0.07**

**Release job:**
- 时间：2 分钟
- 成本：2 × $0.010 = **$0.02**

**总成本：** $0.06 + $0.492 + $0.07 + $0.02 = **$0.642 ≈ $0.64/次**

## 年度成本

| 发版频率 | 月成本 | 年成本 |
|---------|--------|--------|
| 1 次/月 | $0.64 | $7.68 |
| 2 次/月 | $1.28 | $15.36 |
| 4 次/月 | $2.56 | $30.72 |
| 每周 1 次 | $2.56 | $30.72 |

## 免费额度分析

### GitHub 免费账户
- **额度：** 2,000 分钟/月（Linux 倍率）

### 单次发版消耗（Linux 等效分钟）
- Linux musl: 6 × 1 = 6 分钟
- macOS: 6 × 10 = 60 分钟
- Windows: 7 × 1 = 7 分钟
- Release: 2 × 1 = 2 分钟
- **总计：75 分钟**

### 免费发版次数
**2,000 / 75 = 26.6 次/月**

**结论：每月可免费发版 26 次！**

## 成本优化对比

### 方案对比

| 方案 | 平台数 | 单次成本 | 年成本(2次/月) | 免费次数/月 |
|------|--------|---------|---------------|------------|
| **当前配置** | 7 | $0.64 | $15.36 | 26 |
| 仅 Linux + Windows | 5 | $0.15 | $3.60 | 133 |
| 仅 Linux musl | 3 | $0.08 | $1.92 | 250 |
| 全原生构建 | 7 | $1.20 | $28.80 | 13 |

### 推荐配置（当前）

**理由：**
1. **覆盖所有主流平台** - 7 个目标
2. **成本可接受** - $15/年
3. **免费额度充足** - 26 次/月
4. **用户体验最好** - 一键安装所有平台

## musl 的额外优势

### 1. 构建时间更短
musl 构建比 glibc 快 ~15%：
- glibc: ~7 分钟
- musl: ~6 分钟

**节省：** 1 分钟 × $0.010 = $0.01/次

### 2. 更好的兼容性
- 无需担心 glibc 版本
- 单个二进制适用所有 Linux 发行版
- 减少支持成本

### 3. 更小的二进制
- 15-20% 体积减少
- 更快的下载速度
- 更好的用户体验

### 4. 容器优化
```dockerfile
FROM scratch
COPY bulk_upload /
# 镜像大小：仅 5.8 MB
```

## CI 成本（额外）

### 每次 Push/PR
- 运行测试和 lint
- 仅 Linux 构建
- 时间：~8 分钟
- 成本：8 × $0.010 = **$0.08**

### 月度 CI 成本估算
假设：
- 20 次 push/PR
- 2 次 release

**总成本：**
- CI: 20 × $0.08 = $1.60
- Release: 2 × $0.64 = $1.28
- **月总计：$2.88**
- **年总计：$34.56**

### 免费额度使用
- CI: 20 × 8 = 160 分钟
- Release: 2 × 75 = 150 分钟
- **月总计：310 分钟**
- **剩余：1,690 分钟**

**结论：完全在免费额度内！**

## 实际案例

### 典型开源项目
- 每月 10 次 push/PR
- 每月 2 次 release
- **月成本：** $0（免费额度内）
- **消耗：** 230 分钟/月

### 活跃开源项目
- 每月 50 次 push/PR
- 每月 4 次 release
- **月成本：** $0（免费额度内）
- **消耗：** 700 分钟/月

### 商业项目
- 每月 100 次 push/PR
- 每月 8 次 release
- **月成本：** ~$3
- **消耗：** 1,400 分钟/月

## 成本节省技巧

### 1. 使用缓存（已实现）✅
```yaml
- uses: Swatinem/rust-cache@v2
  with:
    cache-all-crates: true
```
**节省：** 50-70% 构建时间

### 2. 条件性构建（已实现）✅
```yaml
# 仅在 tag 时构建 release
on:
  push:
    tags: ['v*.*.*']
```

### 3. 并行构建（已实现）✅
所有平台并行构建，节省总时间。

### 4. musl 优化（已实现）✅
使用 musl 减少构建时间和体积。

### 5. 可选：sccache
```yaml
- uses: mozilla-actions/sccache-action@v0.0.3
```
**额外节省：** 20-30% 构建时间

## 总结

### 最终配置

✅ **7 个平台支持**
- Linux: x86_64, i686, aarch64 (musl)
- macOS: x86_64, aarch64
- Windows: x86_64, i686

✅ **成本优化**
- 单次发版：$0.64
- 年成本：$15.36（2次/月）
- 免费额度：26 次/月

✅ **musl 优势**
- 完全静态链接
- 更小体积
- 更好兼容性
- 更快构建

✅ **用户体验**
- 一键安装所有平台
- 无需依赖
- 最大兼容性

### 关键指标

| 指标 | 值 |
|------|-----|
| 支持平台 | 7 个 |
| 构建时间 | ~21 分钟 |
| 单次成本 | $0.64 |
| 年成本 | $15.36 |
| 免费次数 | 26/月 |
| 二进制大小 | 5.8-10 MB |

**结论：性价比极高的配置！**

---

需要调整配置或有其他问题随时告诉我！
