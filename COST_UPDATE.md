# 更新：实际的跨平台构建成本

## 重要更正 ⚠️

**Linux 无法可靠地交叉编译 macOS 二进制文件**

原因：
- 需要 Apple 专有的 SDK 和工具链
- 法律限制（Apple 许可协议）
- macOS 二进制需要代码签名
- 兼容性问题

## 实际方案：混合构建

### 构建策略

1. **Linux 平台**：在 Ubuntu runner 上使用 `cross` 交叉编译
   - Linux x86_64
   - Linux ARM64
   - Windows x86_64 ✅（可以交叉编译）

2. **macOS 平台**：在 macOS runner 上原生构建
   - macOS x86_64
   - macOS ARM64

### 成本重新计算

#### Runner 定价（2026）

| Runner 类型 | 倍率 | 基础价格 | 平台费用 | 总价格/分钟 |
|------------|------|---------|---------|------------|
| Linux | 1x | $0.008 | $0.002 | $0.010 |
| macOS | 10x | $0.080 | $0.002 | $0.082 |

#### 预估构建时间

**Linux job（并行 3 个目标）：**
- Linux x86_64: ~6 分钟
- Linux ARM64: ~6 分钟
- Windows x86_64: ~7 分钟
- **最长时间：~7 分钟**（并行执行）

**macOS job（并行 2 个目标）：**
- macOS x86_64: ~6 分钟
- macOS ARM64: ~6 分钟
- **最长时间：~6 分钟**（并行执行）

**Release job：**
- 打包和发布：~2 分钟

#### 单次发版成本

**Linux job:**
- 时间：7 分钟
- 成本：7 × $0.010 = **$0.07**

**macOS job:**
- 时间：6 分钟
- 成本：6 × $0.082 = **$0.492**

**Release job:**
- 时间：2 分钟
- 成本：2 × $0.010 = **$0.02**

**总成本：$0.07 + $0.492 + $0.02 = $0.582 ≈ $0.58/次**

### 年度成本估算

| 发版频率 | 月成本 | 年成本 |
|---------|--------|--------|
| 1 次/月 | $0.58 | $6.96 |
| 2 次/月 | $1.16 | $13.92 |
| 4 次/月 | $2.32 | $27.84 |

### 免费额度分析

GitHub 免费账户：2,000 分钟/月（Linux 倍率）

**单次发版消耗（换算为 Linux 分钟）：**
- Linux: 7 分钟 × 1 = 7 分钟
- macOS: 6 分钟 × 10 = 60 分钟
- Release: 2 分钟 × 1 = 2 分钟
- **总计：69 分钟（Linux 等效）**

**每月可免费发版次数：** 2,000 / 69 ≈ **29 次**

## 方案对比

### 方案 1：混合构建（当前配置）✅

**优点：**
- 兼容性最好
- macOS 二进制可靠
- 支持所有主流平台

**缺点：**
- 使用 macOS runner，成本较高
- 单次 $0.58

**适合：** 需要可靠的 macOS 支持

### 方案 2：仅 Linux + Windows

删除 macOS job，只构建 Linux 和 Windows。

**成本：** $0.09/次
**年成本：** $2.16（2次/月）

**适合：** 主要用户在 Linux/Windows

### 方案 3：按需构建 macOS

只在主要版本时构建 macOS，小版本只构建 Linux/Windows。

```yaml
build-macos:
  if: contains(github.ref, '-major') || contains(github.ref, '.0.0')
```

**平均成本：** ~$0.20/次
**适合：** 平衡成本和覆盖率

### 方案 4：使用 Self-hosted macOS Runner

自己维护一台 Mac mini 作为 runner。

**初始成本：** ~$600（Mac mini）
**月成本：** $0.002/分钟 + 电费
**适合：** 高频发版（>50次/月）

## 推荐方案

### 对于个人项目（推荐方案 1）

使用混合构建：
- **成本：** $0.58/次，$13.92/年（2次/月）
- **覆盖：** 所有主流平台
- **可靠性：** 最高

**理由：**
- 年成本不到 $14，可接受
- 每月 29 次免费额度足够
- 用户体验最好

### 对于成本敏感项目（方案 2）

仅构建 Linux + Windows：
- **成本：** $0.09/次，$2.16/年
- **覆盖：** Linux, Windows
- **macOS 用户：** 使用 `cargo install`

### 对于高频发版项目（方案 4）

考虑 self-hosted runner：
- **适用：** 每月 >50 次发版
- **回本周期：** ~6 个月

## 优化建议

### 1. 缓存优化（已实现）

```yaml
- uses: Swatinem/rust-cache@v2
```

可减少 50-70% 构建时间。

### 2. 条件性构建

```yaml
# 仅在 tag 时构建 release
on:
  push:
    tags: ['v*.*.*']
```

### 3. 并行构建（已实现）

Linux 和 macOS job 并行执行，节省总时间。

### 4. 使用 sccache

```yaml
- uses: mozilla-actions/sccache-action@v0.0.3
```

可进一步减少构建时间。

## 实际成本示例

### 典型开源项目

- 每月发版 2 次
- 使用混合构建
- **月成本：** $1.16
- **年成本：** $13.92
- **免费额度剩余：** 2,000 - 138 = 1,862 分钟

### 商业项目

- 每周发版 1 次（4次/月）
- 使用混合构建
- **月成本：** $2.32
- **年成本：** $27.84

## 总结

**更正后的成本：**
- ~~$0.33/次~~（不可行）
- **$0.58/次**（实际可行）

**关键点：**
- macOS 必须在 macOS runner 上构建
- Linux 可以交叉编译 Windows
- 年成本 $14 对大多数项目可接受
- 免费额度足够个人项目使用

需要我根据你的实际需求调整配置吗？
